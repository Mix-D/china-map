<!--新增GDP可视化，地形图模式，
修复1.1的公告栏，搜索框问题-->
<!DOCTYPE html>
<html lang="zh" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中国省级行政区地图与地形图</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#8B5CF6',
                        dark: { primary: '#60a5fa', secondary: '#34d399', accent: '#a78bfa', bg: '#111827', panel: '#1f2937', text: '#f3f4f6' }
                    },
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                    keyframes: {
                        highlight: { '0%, 100%': { transform: 'scale(1)' }, '50%': { transform: 'scale(1.02)' } },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-5px)' } },
                        fadeIn: { '0%': { opacity: 0 }, '100%': { opacity: 1 } }
                    },
                    animation: {
                        highlight: 'highlight 0.5s ease-in-out',
                        float: 'float 3s ease-in-out infinite',
                        fadeIn: 'fadeIn 0.3s ease-in-out forwards'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen dark:bg-gray-900">
    <div class="container mx-auto p-4">
        <header class="mb-8 text-center relative">
            <div class="absolute top-0 right-0 flex flex-col items-end space-y-2">
                <div class="flex items-center space-x-2">
                    <span class="text-sm font-medium text-gray-600 dark:text-gray-300">浅色</span>
                    <button id="theme-toggle" class="relative w-14 h-7 rounded-full bg-gray-300 dark:bg-blue-600 transition-colors">
                        <div id="theme-toggle-handle" class="absolute top-1 left-1 w-5 h-5 rounded-full bg-white shadow-md transform transition-transform"></div>
                    </button>
                    <span class="text-sm font-medium text-gray-600 dark:text-gray-300">深色</span>
                </div>
                <div class="mt-2 w-full">
                    <div class="relative">
                        <input id="search-input" type="text" placeholder="搜索省份（支持拼音/简拼）" class="w-full py-2 pl-10 pr-10 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400">
                        <i class="fa fa-search absolute left-3 top-3 text-gray-400 dark:text-gray-300"></i>
                        <button id="clear-search" class="absolute right-3 top-3 text-gray-400 hover:text-gray-500 dark:text-gray-300 dark:hover:text-gray-200 hidden"><i class="fa fa-times"></i></button>
                        <div id="search-results" class="absolute z-20 w-full mt-1 bg-white rounded-md shadow-lg max-h-60 overflow-y-auto hidden dark:bg-gray-800"></div>
                    </div>
                </div>
            </div>
            <h1 class="text-[clamp(1.8rem,3vw,2.5rem)] font-bold text-gray-800 dark:text-white mt-6">中国地图：行政区划与地形</h1>
            <p class="text-gray-600 dark:text-gray-300 mt-2">点击或悬停查看各省详情 | 使用右上角按钮切换地图模式</p>
            <div class="relative mt-4 overflow-hidden bg-blue-50 border border-blue-200 rounded-lg p-2 dark:bg-blue-900/30 dark:border-blue-800">
                <div id="announcement-bar" class="flex items-center justify-center h-10 cursor-pointer">
                    <div class="flex-shrink-0 mr-2 text-blue-600 dark:text-blue-300"><i class="fa fa-bullhorn text-lg"></i></div>
                    <div class="text-blue-800 dark:text-blue-200">新增地形图模式！可在行政区划图和地形图之间切换</div>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div class="lg:col-span-3 bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden relative">
                <div id="map" class="w-full h-[600px]"></div>
                <div id="map-mode-indicator" class="absolute top-4 left-4 z-[500] bg-white dark:bg-gray-800 px-3 py-2 rounded-lg shadow-md text-sm font-medium flex items-center">
                    <i id="map-icon" class="fa fa-map mr-2 text-blue-500"></i>
                    <span id="current-mode">行政区划图</span>
                </div>
                <div id="map-loader" class="absolute inset-0 bg-white dark:bg-gray-900 bg-opacity-90 dark:bg-opacity-90 flex items-center justify-center z-10 transition-opacity duration-300">
                    <div class="text-center p-6 rounded-xl bg-white/80 dark:bg-gray-800/80 shadow-xl animate-float">
                        <i class="fa fa-spinner fa-spin text-3xl text-blue-500 mb-2"></i>
                        <p class="text-gray-700 dark:text-gray-300 mb-4">地图加载中...</p>
                        <div class="w-64 h-2 bg-gray-200 rounded-full overflow-hidden dark:bg-gray-700">
                            <div id="progress-bar" class="h-full bg-blue-500 w-0 transition-all duration-500"></div>
                        </div>
                    </div>
                </div>
                <div class="absolute bottom-4 right-4 z-[500] flex space-x-2">
                    <button id="reset-view" class="bg-white dark:bg-gray-800 p-2 rounded-full shadow-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center" title="重置视图"><i class="fa fa-globe text-blue-500 mr-1"></i><span class="text-xs">重置</span></button>
                    <button id="compare-provinces" class="bg-white dark:bg-gray-800 p-2 rounded-full shadow-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center" title="省份比较"><i class="fa fa-balance-scale text-green-500 mr-1"></i><span class="text-xs">比较</span></button>
                    <button id="toggle-terrain" class="bg-white dark:bg-gray-800 p-2 rounded-full shadow-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center" title="切换地形图模式"><i class="fa fa-map-o text-orange-500 mr-1"></i><span class="text-xs">地形</span></button>
                </div>
            </div>

            <div id="info-panel" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 h-[600px] overflow-y-auto">
                <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">省份详情</h2>
                <div id="province-info" class="space-y-4 text-gray-700 dark:text-gray-300">
                    <div class="text-center py-8"><i class="fa fa-map-o text-4xl text-blue-300 mb-3"></i><p class="text-gray-500 dark:text-gray-400 italic">请点击地图上的省份或使用搜索功能</p></div>
                </div>
                <div id="comparison-panel" class="hidden mt-6">
                    <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-3">省份比较</h3>
                    <div id="comparison-container" class="grid grid-cols-2 gap-4"></div>
                    <div class="mt-4 flex justify-end">
                        <button id="clear-comparison" class="text-sm px-3 py-1 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 rounded transition-colors">清除比较</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow"><div class="flex items-center"><div class="p-3 rounded-full bg-blue-100 dark:bg-blue-900/50 mr-3"><i class="fa fa-users text-blue-500 text-xl"></i></div><div><p class="text-gray-500 dark:text-gray-400 text-sm">总人口</p><p class="text-xl font-bold dark:text-white">14.4亿</p></div></div></div>
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow"><div class="flex items-center"><div class="p-3 rounded-full bg-green-100 dark:bg-green-900/50 mr-3"><i class="fa fa-map-marker text-green-500 text-xl"></i></div><div><p class="text-gray-500 dark:text-gray-400 text-sm">总面积</p><p class="text-xl font-bold dark:text-white">960万 km²</p></div></div></div>
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow"><div class="flex items-center"><div class="p-3 rounded-full bg-purple-100 dark:bg-purple-900/50 mr-3"><i class="fa fa-flag text-purple-500 text-xl"></i></div><div><p class="text-gray-500 dark:text-gray-400 text-sm">省级行政区</p><p class="text-xl font-bold dark:text-white">34个</p></div></div></div>
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow"><div class="flex items-center"><div class="p-3 rounded-full bg-yellow-100 dark:bg-yellow-900/50 mr-3"><i class="fa fa-line-chart text-yellow-500 text-xl"></i></div><div><p class="text-gray-500 dark:text-gray-400 text-sm">GDP总量</p><p class="text-xl font-bold dark:text-white">126.06万亿元</p></div></div></div>
        </div>
    </div>

    <div id="announcement-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4 overflow-hidden transform transition-all">
            <div class="bg-blue-500 dark:bg-blue-700 text-white p-4 flex justify-between items-center">
                <h3 class="font-bold text-lg">公告信息</h3>
                <button id="close-announcement" class="text-white hover:text-blue-100 transition-colors"><i class="fa fa-times"></i></button>
            </div>
            <div class="p-6">
                <p class="text-gray-700 dark:text-gray-300">欢迎使用中国省级行政区地图！本版本已进行以下优化：</p>
                <ul class="mt-4 list-disc list-inside text-gray-600 dark:text-gray-400 space-y-1">
                    <li>新增拼音/简拼搜索功能</li><li>添加省份比较功能</li><li>新增地形图模式</li><li>优化地图加载性能</li><li>改进深色模式视觉效果</li>
                    <li>优化移动端显示效果</li><li>添加加载进度指示器</li><li>新增GDP数据可视化</li>
                </ul>
                <p class="mt-4 text-gray-700 dark:text-gray-300">感谢您的使用！</p>
            </div>
            <div class="bg-gray-50 dark:bg-gray-700 p-4 flex justify-end">
                <button id="close-announcement-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded transition-colors">我知道了</button>
            </div>
        </div>
    </div>

    <script>
        let map, geojsonLayer, provinceLayers = {}, selectedProvinces = [], currentZoom = 4, currentCenter = [35.86, 104.19], terrainMode = false, tiles, terrainTiles, currentBaseLayer;
        const provinceInfo = {
            "北京市": { name: "北京市", capital: "北京", area: "1.64万平方公里", population: "2184万", description: "北京是中国的首都，是全国的政治中心、文化中心、国际交往中心和科技创新中心。", gdp: "40269.6亿元", pinyin: "beijing", short: "京", color: "#FF6384" },
            "天津市": { name: "天津市", capital: "天津", area: "1.19万平方公里", population: "1364万", description: "天津是中国四大直辖市之一，北方最大的港口城市，国家中心城市。", gdp: "15695.1亿元", pinyin: "tianjin", short: "津", color: "#36A2EB" },
            "河北省": { name: "河北省", capital: "石家庄", area: "18.88万平方公里", population: "7420万", description: "河北省环抱首都北京，是中国重要的粮棉产区和重工业基地。", gdp: "40391.3亿元", pinyin: "hebei", short: "冀", color: "#FFCE56" },
            "山西省": { name: "山西省", capital: "太原", area: "15.67万平方公里", population: "3445.96万", description: "山西省是中国重要的能源基地，煤炭资源丰富，被誉为'煤海'。", gdp: "22590.2亿元", pinyin: "shanxi", short: "晋", color: "#4BC0C0" },
            "辽宁省": { name: "辽宁省", capital: "沈阳", area: "14.8万平方公里", population: "4259万", description: "辽宁省是中国东北沿海省份，是中国重要的老工业基地和粮食生产基地。", gdp: "27584.1亿元", pinyin: "liaoning", short: "辽", color: "#9966FF" },
            "吉林省": { name: "吉林省", capital: "长春", area: "18.74万平方公里", population: "2317.31万", description: "吉林省是中国重要的工业基地和商品粮生产基地，拥有丰富的自然资源和独特的冰雪旅游资源。", gdp: "13235.5亿元", pinyin: "jilin", short: "吉", color: "#FF9F40" },
            "黑龙江省": { name: "黑龙江省", capital: "哈尔滨", area: "47.3万平方千米", population: "3029万", description: "地处东北边陲，是我国重要的粮食生产大省，有广袤的黑土地。冬季的冰雪景观，如哈尔滨冰雪大世界闻名遐迩。", gdp: "14879.2亿元", pinyin: "heilongjiang", short: "黑", color: "#C9CBCF" },
            "上海市": { name: "上海市", capital: "上海", area: "6340平方千米", population: "2480.26万", description: "中国的经济中心、国际化大都市，有外滩、东方明珠等标志性建筑，展现着现代都市风貌。", gdp: "43214.9亿元", pinyin: "shanghai", short: "沪", color: "#FF6384" },
            "浙江省": { name: "浙江省", capital: "杭州", area: "10.55万平方千米", population: "6670万", description: "风景秀丽，互联网经济发达。杭州西湖、千岛湖等自然景观美不胜收，乌镇等古镇充满江南韵味。", gdp: "73516亿元", pinyin: "zhejiang", short: "浙", color: "#36A2EB" },
            "安徽省": { name: "安徽省", capital: "合肥", area: "14万平方千米", population: "6123万", description: "有\"江淮大地\"之称，自然风光与人文景观相得益彰，黄山是其著名的旅游名片。", gdp: "42959.2亿元", pinyin: "anhui", short: "皖", color: "#FFCE56" },
            "福建省": { name: "福建省", capital: "福州", area: "12.4万平方千米", population: "4193万", description: "东南沿海省份，海岸线漫长，鼓浪屿、武夷山等景点吸引大量游客，茶文化也源远流长。", gdp: "48810.4亿元", pinyin: "fujian", short: "闽", color: "#4BC0C0" },
            "江西省": { name: "江西省", capital: "南昌", area: "16.69万平方千米", population: "4502万", description: "红色革命根据地，有井冈山等红色旅游景点，鄱阳湖是我国最大的淡水湖。", gdp: "29619.7亿元", pinyin: "jiangxi", short: "赣", color: "#9966FF" },
            "山东省": { name: "山东省", capital: "济南", area: "15.8万平方千米", population: "10080.17万", description: "经济强省，有\"孔孟之乡\"的美誉，泰山雄伟壮观，青岛的海滨景色迷人。", gdp: "83095.9亿元", pinyin: "shandong", short: "鲁", color: "#FF9F40" },
            "河南省": { name: "河南省", capital: "郑州", area: "16.7万平方千米", population: "9785万", description: "中原大地，历史悠久，是华夏文明的重要发祥地之一，少林寺闻名世界。", gdp: "58887.4亿元", pinyin: "henan", short: "豫", color: "#C9CBCF" },
            "湖北省": { name: "湖北省", capital: "武汉", area: "18.59万平方千米", population: "5834万", description: "有\"九省通衢\"之称，武汉黄鹤楼、三峡大坝等是著名景点，农业和工业都较为发达。", gdp: "50012.9亿元", pinyin: "hubei", short: "鄂", color: "#FF6384" },
            "湖南省": { name: "湖南省", capital: "长沙", area: "21.18万平方千米", population: "6539万", description: "因大部分区域处于洞庭湖以南而得名，张家界的奇峰异石、凤凰古城独具魅力。", gdp: "46063.1亿元", pinyin: "hunan", short: "湘", color: "#36A2EB" },
            "广东省": { name: "广东省", capital: "广州", area: "17.97万平方千米", population: "12800万", description: "经济第一大省，开放程度高，广州塔、深圳的现代化都市景观以及众多美食吸引着各地游客。", gdp: "124369.7亿元", pinyin: "guangdong", short: "粤", color: "#FFCE56" },
            "海南省": { name: "海南省", capital: "海口", area: "3.54万平方千米", population: "1048万", description: "我国唯一的热带海岛省份，三亚的海滨风光闻名遐迩，是度假旅游胜地。", gdp: "6475.2亿元", pinyin: "hainan", short: "琼", color: "#4BC0C0" },
            "四川省": { name: "四川省", capital: "成都", area: "48.6万平方千米", population: "8364万", description: "地处西南，有九寨沟、峨眉山等美景，还是大熊猫的故乡，美食文化丰富，如火锅、川菜等。", gdp: "53850.8亿元", pinyin: "sichuan", short: "川", color: "#9966FF" },
            "贵州省": { name: "贵州省", capital: "贵阳", area: "17.6万平方千米", population: "3860万", description: "多山地，自然风光独特，黄果树瀑布气势磅礴，还有浓郁的少数民族风情。", gdp: "19586.4亿元", pinyin: "guizhou", short: "黔", color: "#FF9F40" },
            "云南省": { name: "云南省", capital: "昆明", area: "39万平方千米", population: "4655万", description: "动植物王国，自然景观多样，大理洱海、丽江古城充满浪漫与诗意，少数民族文化多姿多彩。", gdp: "28954.2亿元", pinyin: "yunnan", short: "云", color: "#C9CBCF" },
            "陕西省": { name: "陕西省", capital: "西安", area: "20.58万平方千米", population: "3953万", description: "历史文化大省，西安作为十三朝古都，兵马俑、古城墙见证着历史的辉煌。", gdp: "29800.9亿元", pinyin: "shaanxi", short: "陕", color: "#FF6384" },
            "甘肃省": { name: "甘肃省", capital: "兰州", area: "45.37万平方千米", population: "2388万", description: "地处西北，河西走廊贯穿其中，敦煌莫高窟是艺术瑰宝，还有独特的大漠风光。", gdp: "10243.3亿元", pinyin: "gansu", short: "甘", color: "#36A2EB" },
            "青海省": { name: "青海省", capital: "西宁", area: "72.1万平方千米", population: "593万", description: "有\"世界屋脊\"的美称，青海湖是我国最大的内陆咸水湖，可可西里自然保护区是野生动物的天堂。", gdp: "3346.6亿元", pinyin: "qinghai", short: "青", color: "#FFCE56" },
            "内蒙古自治区": { name: "内蒙古自治区", capital: "呼和浩特", area: "118.3万平方千米", population: "2458.34万", description: "广袤的草原是其特色，有成群的牛羊和独特的蒙古族文化，呼伦贝尔大草原闻名世界。", gdp: "20514.2亿元", pinyin: "neimenggu", short: "蒙", color: "#4BC0C0" },
            "广西壮族自治区": { name: "广西壮族自治区", capital: "南宁", area: "23.67万平方千米", population: "5013万", description: "山水如画，桂林山水甲天下，还有浓郁的壮族风情和美丽的北部湾海滨风光。", gdp: "24740.9亿元", pinyin: "guangxi", short: "桂", color: "#9966FF" },
            "西藏自治区": { name: "西藏自治区", capital: "拉萨", area: "122.84万平方千米", population: "370万", description: "世界屋脊，有壮丽的雪山、神秘的宗教文化，布达拉宫是其标志性建筑。", gdp: "2080.2亿元", pinyin: "xizang", short: "藏", color: "#FF9F40" },
            "宁夏回族自治区": { name: "宁夏回族自治区", capital: "银川", area: "6.64万平方千米", population: "729万", description: "有独特的回族文化，沙湖、沙坡头融合了沙漠与水域景观，别具一格。", gdp: "4522.3亿元", pinyin: "ningxia", short: "宁", color: "#C9CBCF" },
            "新疆维吾尔自治区": { name: "新疆维吾尔自治区", capital: "乌鲁木齐", area: "166万平方千米", population: "2585万", description: "面积最大的自治区，自然风光壮美，有天山天池、喀纳斯湖，还有丰富的瓜果资源。", gdp: "15983.7亿元", pinyin: "xinjiang", short: "新", color: "#FF6384" },
            "重庆市": { name: "重庆市", capital: "重庆", area: "8.2万平方千米", population: "3190.47万", description: "山城重庆，有独特的立体交通和夜景，火锅文化盛行，洪崖洞是热门打卡地。", gdp: "27894.0亿元", pinyin: "chongqing", short: "渝", color: "#36A2EB" },
            "江苏省": { name: "江苏省", capital: "南京", area: "10.72万平方千米", population: "8526万", description: "经济发达，文化底蕴深厚，有苏州园林、南京夫子庙等人文景观，还有美丽的水乡风光。", gdp: "116364.2亿元", pinyin: "jiangsu", short: "苏", color: "#FFCE56" },
            "香港特别行政区": { name: "香港特别行政区", area: "陆地总面积1113.76平方公里，海域面积1641.21平方公里", population: "741.3万", description: "位于中国东南部，由香港岛、九龙、新界和周围262个岛屿组成。是国际金融、航运和贸易中心，粤港澳大湾区中心城市之一，有'东方好莱坞''东方之珠''美食天堂''购物天堂'等美誉。", gdp: "约2.83万亿港元", pinyin: "xianggang", short: "港", color: "#4BC0C0" },
            "澳门特别行政区": { name: "澳门特别行政区", area: "陆地面积32.9平方公里", population: "68.83万", description: "位于中国南部珠江口西侧，是中国内地与中国南海的水陆交汇处。是国际自由港，以博彩业和旅游业为支柱产业，有大三巴牌坊等著名景点，融合了中西方文化特色。", gdp: "约1773亿澳门元", pinyin: "aomen", short: "澳", color: "#9966FF" },
            "台湾省": { name: "台湾省", capital: "台北", area: "3.6万平方千米", population: "2340.02万", description: "中国省级行政区，由中国第一大岛台湾岛与兰屿、绿岛、钓鱼岛等附属岛屿和澎湖列岛组成。有阿里山、日月潭等自然美景，以及丰富的人文景观，是中国不可分割的一部分。", gdp: "约4.9万亿元新台币", pinyin: "taiwan", short: "台", color: "#FF9F40" },
            "南海诸岛": { name: "南海诸岛", area: "约210万平方千米", description: "南海诸岛是中国南海中许多岛礁的总称，拥有丰富的海洋资源和独特的海洋生态系统。", pinyin: "nanhaizhudao" },
            "十段线": { name: "十段线", description: "十段线是中国在南海海域国界线的一种表示形式，体现了中国对南海相关海域及其岛屿的主权和权益。", pinyin: "shiduanxian" }
        };
        const provinceNames = Object.keys(provinceInfo);

        function getProvinceName(props) {
            const possibleNames = [props.name, props.NAME, props.name_cn, props.name_zh, props.name_en, props.NAME_CHN];
            const matchedName = possibleNames.find(name => name !== undefined && name !== null);
            const mapping = {
                "北京": "北京市", "天津": "天津市", "河北": "河北省", "山西": "山西省", "辽宁": "辽宁省", "吉林": "吉林省", "黑龙江": "黑龙江省", "上海": "上海市",
                "江苏": "江苏省", "浙江": "浙江省", "安徽": "安徽省", "福建": "福建省", "江西": "江西省", "山东": "山东省", "河南": "河南省", "湖北": "湖北省",
                "湖南": "湖南省", "广东": "广东省", "海南": "海南省", "四川": "四川省", "贵州": "贵州省", "云南": "云南省", "陕西": "陕西省", "甘肃": "甘肃省",
                "青海": "青海省", "内蒙古": "内蒙古自治区", "广西": "广西壮族自治区", "西藏": "西藏自治区", "宁夏": "宁夏回族自治区", "新疆": "新疆维吾尔自治区",
                "重庆": "重庆市", "香港": "香港特别行政区", "澳门": "澳门特别行政区", "台湾": "台湾省", "南海诸岛": "南海诸岛", "十段线": "十段线"
            };
            return mapping[matchedName] || matchedName || null;
        }

        function setupSearch() {
            const searchInput = document.getElementById('search-input');
            const searchResults = document.getElementById('search-results');
            const clearSearch = document.getElementById('clear-search');
            let selectedIndex = -1;

            function updateClearButton() {
                clearSearch.classList.toggle('hidden', searchInput.value.trim().length === 0);
            }

            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.trim().toLowerCase();
                searchResults.innerHTML = '';
                selectedIndex = -1;
                updateClearButton();
                if (searchTerm.length < 1) return searchResults.classList.add('hidden');

                const results = provinceNames.filter(name => {
                    const info = provinceInfo[name];
                    const pinyin = info.pinyin || '';
                    const short = info.short || '';
                    return name.toLowerCase().includes(searchTerm) ||
                        (info.capital && info.capital.toLowerCase().includes(searchTerm)) ||
                        pinyin.includes(searchTerm) ||
                        pinyin.substring(0, searchTerm.length) === searchTerm ||
                        (short && short.toLowerCase().includes(searchTerm));
                });

                if (results.length > 0) {
                    results.forEach((province, index) => {
                        const resultItem = document.createElement('div');
                        resultItem.className = `px-4 py-2 hover:bg-blue-100 cursor-pointer dark:hover:bg-blue-900 dark:text-white ${index === selectedIndex ? 'bg-blue-100 dark:bg-blue-900' : ''}`;
                        resultItem.textContent = province;
                        resultItem.dataset.index = index;
                        resultItem.addEventListener('click', () => {
                            searchInput.value = '';
                            searchResults.classList.add('hidden');
                            clearSearch.classList.add('hidden');
                            highlightProvince(province);
                        });
                        searchResults.appendChild(resultItem);
                    });
                    searchResults.classList.remove('hidden');
                } else {
                    const noResult = document.createElement('div');
                    noResult.className = 'px-4 py-2 text-gray-500 dark:text-gray-400';
                    noResult.textContent = '无匹配结果';
                    searchResults.appendChild(noResult);
                    searchResults.classList.remove('hidden');
                }
            });

            clearSearch.addEventListener('click', function() {
                searchInput.value = '';
                searchResults.classList.add('hidden');
                this.classList.add('hidden');
                searchInput.focus();
            });

            searchInput.addEventListener('keydown', function(e) {
                const items = searchResults.querySelectorAll('div');
                if (e.key === 'ArrowDown' && items.length > 0) {
                    e.preventDefault();
                    selectedIndex = (selectedIndex + 1) % items.length;
                    updateSelectedItem(items, selectedIndex);
                } else if (e.key === 'ArrowUp' && items.length > 0) {
                    e.preventDefault();
                    selectedIndex = (selectedIndex - 1 + items.length) % items.length;
                    updateSelectedItem(items, selectedIndex);
                } else if (e.key === 'Enter' && items.length > 0 && selectedIndex >= 0) {
                    e.preventDefault();
                    const province = items[selectedIndex].textContent;
                    searchInput.value = '';
                    searchResults.classList.add('hidden');
                    clearSearch.classList.add('hidden');
                    highlightProvince(province);
                } else if (e.key === 'Escape') {
                    searchResults.classList.add('hidden');
                }
            });

            document.addEventListener('click', function(e) {
                if (!searchResults.contains(e.target))searchResults.classList.add('hidden');
            });
        }

        function updateSelectedItem(items, index) {
            items.forEach((item, i) => {
                item.classList.toggle('bg-blue-100', i === index);
                item.classList.toggle('dark:bg-blue-900', i === index);
                if (i === index) item.scrollIntoView({ block: 'nearest' });
            });
        }

        function highlightProvince(provinceName) {
            const layer = provinceLayers[provinceName];
            if (!layer) return;
            layer.getElement().classList.add('animate-highlight');
            setTimeout(() => layer.getElement().classList.remove('animate-highlight'), 500);
            const isDarkMode = document.documentElement.classList.contains('dark');
            layer.setStyle(getHoverStyle(isDarkMode));
            map.fitBounds(layer.getBounds());
            displayProvinceInfo(provinceName);
        }

        function displayProvinceInfo(provinceName) {
            const info = provinceInfo[provinceName];
            if (!info) return;
            let gdpChart = '';
            if (info.gdp) {
                const gdpValue = parseFloat(info.gdp.replace(/[^0-9.]/g, ''));
                const maxGDP = 124369.7;
                const width = Math.min(100, (gdpValue / maxGDP) * 100);
                gdpChart = `<div class="mt-4"><div class="flex justify-between mb-1"><span class="text-sm font-medium">GDP</span><span class="text-sm font-medium">${info.gdp}</span></div><div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700"><div class="bg-green-600 h-2.5 rounded-full" style="width: ${width}%"></div></div><div class="flex justify-between mt-1 text-xs text-gray-500 dark:text-gray-400"><span>0</span><span>${maxGDP.toLocaleString()}亿元 (广东省)</span></div></div>`;
            }

            let html = `<div class="space-y-4"><div class="flex justify-between items-start"><h3 class="text-2xl font-bold text-primary dark:text-blue-300">${provinceName}</h3><span class="text-sm bg-blue-100 dark:bg-blue-900/50 px-2 py-1 rounded">${info.short || ''}</span></div><div class="flex flex-wrap gap-4">`;
            if (provinceName !== '十段线' && info.area) html += `<div class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded-lg flex-1 min-w-[120px]"><div class="flex items-center"><i class="fa fa-map-o mr-2 text-blue-500"></i><span class="font-medium">面积</span></div><div class="mt-1 text-lg font-semibold">${info.area}</div></div>`;
            if (provinceName !== '南海诸岛' && provinceName !== '十段线') {
                if (info.capital) html += `<div class="bg-green-50 dark:bg-green-900/30 p-3 rounded-lg flex-1 min-w-[120px]"><div class="flex items-center"><i class="fa fa-building-o mr-2 text-green-500"></i><span class="font-medium">省会/首府</span></div><div class="mt-1 text-lg font-semibold">${info.capital}</div></div>`;
                if (info.population) html += `<div class="bg-purple-50 dark:bg-purple-900/30 p-3 rounded-lg flex-1 min-w-[120px]"><div class="flex items-center"><i class="fa fa-users mr-2 text-purple-500"></i><span class="font-medium">人口</span></div><div class="mt-1 text-lg font-semibold">${info.population}</div></div>`;
                if (info.gdp) html += `<div class="bg-yellow-50 dark:bg-yellow-900/30 p-3 rounded-lg flex-1 min-w-[120px]"><div class="flex items-center"><i class="fa fa-money mr-2 text-yellow-500"></i><span class="font-medium">GDP</span></div><div class="mt-1 text-lg font-semibold">${info.gdp}</div></div>`;
            }
            html += `</div>${gdpChart}`;
            if (provinceName !== '南海诸岛' && provinceName !== '十段线') html += `<div class="mt-4 flex justify-end"><button id="add-to-compare" data-province="${provinceName}" class="text-sm px-3 py-1 bg-blue-100 hover:bg-blue-200 dark:bg-blue-900/50 dark:hover:bg-blue-900 rounded transition-colors"><i class="fa fa-plus mr-1"></i>添加到比较</button></div>`;
            if (info.description) html += `<div class="mt-4"><h4 class="font-semibold text-gray-700 dark:text-gray-200 mb-2">简介:</h4><p class="text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">${info.description}</p></div>`;
            html += `</div>`;
            document.getElementById('province-info').innerHTML = html;
            document.getElementById('comparison-panel').classList.add('hidden');
            const addBtn = document.getElementById('add-to-compare');
            if (addBtn) addBtn.addEventListener('click', function() { addProvinceToComparison(this.dataset.province); });
        }

        function addProvinceToComparison(provinceName) {
            if (selectedProvinces.length >= 2) return alert('最多可以比较两个省份');
            if (!selectedProvinces.includes(provinceName)) {
                selectedProvinces.push(provinceName);
                updateComparisonPanel();
                document.getElementById('province-info').innerHTML = `<div class="text-center py-8 animate-fadeIn"><i class="fa fa-check-circle text-4xl text-green-500 mb-3"></i><p class="text-lg font-medium">已添加 ${provinceName} 到比较列表</p><p class="text-gray-500 dark:text-gray-400 mt-2">继续添加另一个省份进行比较</p></div>`;
            }
        }

        function updateComparisonPanel() {
            const panel = document.getElementById('comparison-panel');
            panel.classList.toggle('hidden', selectedProvinces.length === 0);
            if (selectedProvinces.length === 0) return;

            let html = '', gdpData = [];
            selectedProvinces.forEach(provinceName => {
                const info = provinceInfo[provinceName];
                if (!info) return;
                if (info.gdp) {
                    const gdpValue = parseFloat(info.gdp.replace(/[^0-9.]/g, ''));
                    gdpData.push({ name: provinceName, gdp: gdpValue, color: info.color || '#3B82F6' });
                }
                html += `<div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg"><div class="flex justify-between items-center mb-2"><h4 class="font-bold text-gray-800 dark:text-white">${provinceName}</h4><button class="text-red-500 hover:text-red-700 remove-comparison" data-province="${provinceName}"><i class="fa fa-times"></i></button></div><div class="space-y-2">${info.capital?`<div><span class="font-medium">省会:</span> ${info.capital}</div>`:''}${info.area?`<div><span class="font-medium">面积:</span> ${info.area}</div>`:''}${info.population?`<div><span class="font-medium">人口:</span> ${info.population}</div>`:''}${info.gdp?`<div><span class="font-medium">GDP:</span> ${info.gdp}</div>`:''}</div></div>`;
            });

            if (gdpData.length > 1) {
                const maxGDP = Math.max(...gdpData.map(d => d.gdp));
                html += `<div class="mt-4"><h4 class="font-semibold mb-2">GDP比较</h4><div class="space-y-3">`;
                gdpData.forEach(data => {
                    const width = (data.gdp / maxGDP) * 100;
                    html += `<div><div class="flex justify-between text-sm mb-1"><span>${data.name}</span><span>${data.gdp.toLocaleString()}亿元</span></div><div class="w-full bg-gray-200 rounded-full h-3 dark:bg-gray-700"><div class="h-3 rounded-full" style="width: ${width}%; background-color: ${data.color}"></div></div></div>`;
                });
                html += '</div></div>';
            }

            document.getElementById('comparison-container').innerHTML = html;
            document.querySelectorAll('.remove-comparison').forEach(btn => {
                btn.addEventListener('click', () => removeProvinceFromComparison(btn.dataset.province));
            });
        }

        function removeProvinceFromComparison(provinceName) {
            selectedProvinces = selectedProvinces.filter(name => name !== provinceName);
            updateComparisonPanel();
        }

        function clearComparison() {
            selectedProvinces = [];
            updateComparisonPanel();
        }

        function getStyle(isDarkMode = false) {
            return terrainMode ? {
                fillColor: 'transparent', weight: 1.5, opacity: 1, color: isDarkMode ? 'rgba(255,255,255,0.8)' : 'rgba(0,0,0,0.8)', dashArray: '', fillOpacity: 0
            } : {
                fillColor: isDarkMode ? '#3B82F6' : '#3B82F6', weight: 2, opacity: 1, color: isDarkMode ? '#e5e7eb' : 'white', dashArray: '3', fillOpacity: isDarkMode ? 0.8 : 0.7
            };
        }

        function getHoverStyle(isDarkMode = false) {
            return terrainMode ? {
                weight: 3, color: isDarkMode ? 'white' : 'black', dashArray: '', fillOpacity: 0
            } : {
                weight: 5, color: isDarkMode ? '#93c5fd' : '#666', dashArray: '', fillOpacity: 0.9
            };
        }

        function toggleTerrainMode() {
            terrainMode = !terrainMode;
            const terrainBtn = document.getElementById('toggle-terrain');
            const modeIndicator = document.getElementById('current-mode');
            const mapIcon = document.getElementById('map-icon');

            if (terrainMode) {
                terrainBtn.classList.add('bg-orange-500', 'text-white');
                terrainBtn.classList.remove('text-orange-500', 'dark:text-white');
                modeIndicator.textContent = "地形图";
                mapIcon.className = "fa fa-mountain mr-2 text-orange-500";
            } else {
                terrainBtn.classList.remove('bg-orange-500', 'text-white');
                const isDarkMode = document.documentElement.classList.contains('dark');
                isDarkMode ? terrainBtn.classList.add('dark:text-white') : terrainBtn.classList.add('text-orange-500');
                modeIndicator.textContent = "行政区划图";
                mapIcon.className = "fa fa-map mr-2 text-blue-500";
            }

            currentBaseLayer.remove();
            currentBaseLayer = (terrainMode ? terrainTiles : tiles).addTo(map);
            const isDarkMode = document.documentElement.classList.contains('dark');
            geojsonLayer.eachLayer(layer => layer.setStyle(getStyle(isDarkMode)));
            setTimeout(() => map.invalidateSize(true), 300);
        }

        function initMap() {
            loadMapState();
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView(currentCenter, currentZoom);
            map.on('moveend', saveMapState).on('zoomend', saveMapState);

            tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors', maxZoom: 18
            });
            terrainTiles = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}', {
                maxZoom: 13, attribution: 'Tiles &copy; Esri'
            }).on('tileerror', error => console.error('地形图加载失败:', error));

            currentBaseLayer = tiles.addTo(map);
            L.control.zoom({ position: 'topright' }).addTo(map);
            L.control.attribution({ position: 'bottomright', prefix: '<a href="https://leafletjs.com" title="Leaflet地图库">Leaflet</a>' }).addTo(map);

            const progressBar = document.getElementById('progress-bar');
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 5;
                if (progress > 90) clearInterval(progressInterval);
                progressBar.style.width = `${progress}%`;
            }, 200);

            const geojsonUrl = 'https://geo.datav.aliyun.com/areas_v3/bound/100000_full.json';
            const backupUrl = 'https://cdn.jsdelivr.net/npm/echarts@5.4.3/map/json/china.json';

            function loadGeoJSON(url) {
                fetch(url).then(response => {
                    if (!response.ok) throw new Error(`HTTP错误: ${response.status}`);
                    return response.json();
                }).then(geojson => {
                    if (!geojson || !geojson.features || geojson.features.length === 0) throw new Error('GeoJSON数据为空或格式不正确');
                    const isDarkMode = document.documentElement.classList.contains('dark');
                    geojsonLayer = L.geoJSON(geojson, {
                        style: getStyle(isDarkMode),
                        onEachFeature: function(feature, layer) {
                            const props = feature.properties;
                            const provinceName = getProvinceName(props);
                            if (provinceName) provinceLayers[provinceName] = layer;
                            layer.on({
                                mouseover: function(e) {
                                    const layer = e.target;
                                    const isDarkMode = document.documentElement.classList.contains('dark');
                                    layer.setStyle(getHoverStyle(isDarkMode));
                                    displayProvinceInfo(provinceName || "未知省份");
                                },
                                mouseout: function(e) {
                                    const isDarkMode = document.documentElement.classList.contains('dark');
                                    e.target.setStyle(getStyle(isDarkMode));
                                },
                                click: function(e) { map.fitBounds(e.target.getBounds()); }
                            });
                        }
                    }).addTo(map);
                    map.fitBounds(geojsonLayer.getBounds());
                    clearInterval(progressInterval);
                    progressBar.style.width = '100%';
                    setTimeout(() => document.getElementById('map-loader').classList.add('hidden'), 300);
                }).catch(error => {
                    console.error('地图数据加载失败:', error);
                    if (url === geojsonUrl) loadGeoJSON(backupUrl);
                    else {
                        document.getElementById('province-info').innerHTML = `<div class="text-red-500 font-semibold">地图数据加载失败</div><p class="text-gray-600 dark:text-gray-400">${error.message}</p><p class="text-gray-600 dark:text-gray-400">请检查网络连接或刷新页面</p><button id="retry-load-map" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">重试加载</button>`;
                        document.getElementById('map-loader').classList.add('hidden');
                        document.getElementById('retry-load-map').addEventListener('click', initMap);
                    }
                });
            }
            loadGeoJSON(geojsonUrl);
        }

        function saveMapState() {
            if (!map) return;
            const center = map.getCenter();
            localStorage.setItem('mapState', JSON.stringify({ center: [center.lat, center.lng], zoom: map.getZoom() }));
        }

        function loadMapState() {
            const savedState = localStorage.getItem('mapState');
            if (!savedState) return;
            try {
                const state = JSON.parse(savedState);
                currentCenter = state.center;
                currentZoom = state.zoom;
            } catch (e) { console.log('使用默认地图视图'); }
        }

        function showAnnouncementModal() {
            document.getElementById('announcement-modal').classList.remove('hidden');
            if (map) { map.dragging.disable(); map.touchZoom.disable(); map.doubleClickZoom.disable(); map.scrollWheelZoom.disable(); }
        }

        function hideAnnouncementModal() {
            document.getElementById('announcement-modal').classList.add('hidden');
            if (map) { map.dragging.enable(); map.touchZoom.enable(); map.doubleClickZoom.enable(); map.scrollWheelZoom.enable(); }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const themeToggle = document.getElementById('theme-toggle');
            const themeToggleHandle = document.getElementById('theme-toggle-handle');
            const userTheme = localStorage.getItem('theme');
            const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (userTheme === 'dark' || (!userTheme && systemTheme)) {
                document.documentElement.classList.add('dark');
                themeToggleHandle.style.transform = 'translateX(28px)';
            } else {
                document.documentElement.classList.remove('dark');
                themeToggleHandle.style.transform = 'translateX(0)';
            }
            themeToggle.addEventListener('click', () => {
                if (document.documentElement.classList.contains('dark')) {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                    themeToggleHandle.style.transform = 'translateX(0)';
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                    themeToggleHandle.style.transform = 'translateX(28px)';
                }
                document.dispatchEvent(new Event('themeChange'));
            });

            setupSearch();
            initMap();
            document.getElementById('announcement-bar').addEventListener('click', showAnnouncementModal);
            document.getElementById('close-announcement').addEventListener('click', hideAnnouncementModal);
            document.getElementById('close-announcement-btn').addEventListener('click', hideAnnouncementModal);
            document.getElementById('reset-view').addEventListener('click', () => map.setView(currentCenter, currentZoom));
            document.getElementById('compare-provinces').addEventListener('click', () => {
                document.getElementById('comparison-panel').classList.remove('hidden');
                document.getElementById('province-info').innerHTML = `<div class="text-center py-8"><i class="fa fa-balance-scale text-4xl text-green-300 mb-3"></i><p class="text-gray-500 dark:text-gray-400 italic">已打开省份比较面板</p></div>`;
            });
            document.getElementById('clear-comparison').addEventListener('click', clearComparison);
            document.getElementById('toggle-terrain').addEventListener('click', toggleTerrainMode);
            document.addEventListener('themeChange', () => {
                if (!geojsonLayer) return;
                const isDarkMode = document.documentElement.classList.contains('dark');
                geojsonLayer.eachLayer(layer => layer.setStyle(getStyle(isDarkMode)));
            });
        });
    </script>

    <style>
        #map { border-radius: 0.75rem; }
        #announcement-modal { z-index: 1000; }
        #announcement-modal.hidden { pointer-events: none; }
        .dark .leaflet-container { background-color: #1a202c !important; }
        .dark .leaflet-bar a { background-color: #2d3748; color: #e2e8f0; border-bottom: 1px solid #4a5568; }
        .dark .leaflet-bar a:hover { background-color: #4a5568; }
        .dark .leaflet-popup-content-wrapper, .dark .leaflet-popup-tip { background-color: #2d3748; color: #e2e8f0; }
        .dark .leaflet-control-attribution { background-color: rgba(45, 55, 72, 0.7); color: #cbd5e0; }
        #info-panel::-webkit-scrollbar { width: 8px; }
        #info-panel::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        #info-panel::-webkit-scrollbar-thumb { background: #c5c5c5; border-radius: 4px; }
        .dark #info-panel::-webkit-scrollbar-track { background: #374151; }
        .dark #info-panel::-webkit-scrollbar-thumb { background: #4b5563; }
        #announcement-bar:hover { background-color: rgba(59, 130, 246, 0.1); }
        .dark #announcement-bar:hover { background-color: rgba(59, 130, 246, 0.2); }
        .animate-highlight { animation: highlight 0.5s ease-in-out; }
        #map-loader { backdrop-filter: blur(4px); }
        .leaflet-tile { filter: grayscale(0.3) contrast(1.1) brightness(1.05); }
        .dark .leaflet-tile { filter: grayscale(0.4) contrast(1.2) brightness(0.8); }
        #reset-view:hover, #compare-provinces:hover, #toggle-terrain:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .dark #reset-view, .dark #compare-provinces, .dark #toggle-terrain, .dark #map-mode-indicator { color: white; }
        #toggle-terrain.terrain-active, #toggle-terrain.terrain-active i, #toggle-terrain.terrain-active span { background-color: #f97316; color: white !important; }
        @media (max-width: 768px) {
            .grid-cols-1.lg\:grid-cols-4 { grid-template-columns: 1fr; }
            #map, #info-panel { height: 400px; }
        }
    </style>
</body>
</html>